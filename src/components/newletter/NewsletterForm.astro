---
// src/components/newsletter/NewsletterForm.astro
// Removed unused import
import EmailPreview from './EmailPreview.astro';

// Estado inicial
const initialContent = {
  subject: '',
  salutation: 'Estimados colaboradores,',
  title: '',
  content: '',
  closing: 'Saludos cordiales,',
  signature: 'El equipo de Comunicaciones'
};
---

<div class="newsletter-app">
  <div class="editor-grid">
    <!-- Panel de Edici√≥n -->
    <div class="editor-panel">      
      <form id="newsletter-form">
        <div class="form-section">
          <h3 class="section-title">üìß Informaci√≥n del Email</h3>
          <div class="form-group">
            <label for="subject">
              Asunto del Email:
              <span class="required" aria-label="Campo obligatorio">*</span>
            </label>
            <input 
              type="text" 
              id="subject" 
              name="subject"
              placeholder="Ej: Bolet√≠n Informativo Septiembre 2024"
              value={initialContent.subject}
              required
              aria-describedby="subject-help"
            />
            <small id="subject-help">Este ser√° el asunto que aparecer√° en el email</small>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">üìù Contenido Principal</h3>
          
          <div class="form-group">
            <label for="title">T√≠tulo Principal:</label>
            <input 
              type="text" 
              id="title" 
              name="title"
              placeholder="Ej: Nuevas Actualizaciones Importantes"
            />
          </div>

          <div class="form-group">
            <label for="content">
              Contenido Principal:
              <span class="feature-badge">‚ú® Soporta formato</span>
            </label>
            <div 
              id="content"               
              contenteditable="true"
              data-placeholder="Escribe aqu√≠ el contenido principal del bolet√≠n. Puedes pegar contenido con formato desde otras fuentes y se preservar√°n los estilos autom√°ticamente.

üí° Tip: Puedes pegar tablas, texto con formato, listas, etc. desde Word, Excel, p√°ginas web o cualquier otra fuente."
              class="content-editor"
            ></div>
            <div class="editor-help">
              <span class="help-icon">üí°</span>
              <span>Soporta contenido pegado con formato. Los estilos se preservar√°n autom√°ticamente.</span>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">üé® Elementos Visuales</h3>
          
          <div class="form-group">
            <label for="imageUrl">URL de Imagen (opcional):</label>
            <input 
              type="url" 
              id="imageUrl" 
              name="imageUrl"
              placeholder="https://ejemplo.com/imagen.jpg"
            />
            <small>Agrega una imagen para hacer tu bolet√≠n m√°s atractivo</small>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">üîó Llamada a la Acci√≥n</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="ctaText">Texto del Bot√≥n:</label>
              <input 
                type="text" 
                id="ctaText" 
                name="ctaText"
                placeholder="Ej: Leer m√°s, Ver detalles"
              />
            </div>

            <div class="form-group">
              <label for="ctaUrl">Enlace del Bot√≥n:</label>
              <input 
                type="url" 
                id="ctaUrl" 
                name="ctaUrl"
                placeholder="https://ejemplo.com"
              />
            </div>
          </div>
          <small class="section-help">Ambos campos son opcionales. Si completas uno, completa ambos para mejor resultado.</small>
        </div>
      </form>

      <div class="actions">
        <button type="button" class="btn btn-secondary" onclick="clearForm()">
          üóëÔ∏è Limpiar Formulario
        </button>
      </div>
    </div>

    <!-- Vista Previa -->
    <EmailPreview />
  </div>
</div>

<style>
  .newsletter-app {
    background: white;
    border-radius: 10px;
    padding: 30px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
  }

  .editor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
  }

  @media (max-width: 1024px) {
    .editor-grid {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .newsletter-app {
      padding: 20px;
    }
  }

  @media (max-width: 768px) {
    .newsletter-app {
      padding: 15px;
      border-radius: 8px;
    }
    
    .editor-grid {
      gap: 15px;
    }
  }

  .editor-panel {
    padding: 20px;
  }

  .panel-header {
    margin-bottom: 30px;
    text-align: center;
  }

  .panel-header h2 {
    margin: 0 0 8px 0;
    color: #2c3e50;
    font-size: 1.8rem;
  }

  .panel-description {
    margin: 0;
    color: #7f8c8d;
    font-size: 14px;
  }

  .form-section {
    margin-bottom: 35px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
  }

  .section-title {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-help {
    display: block;
    margin-top: 10px;
    color: #7f8c8d;
    font-size: 12px;
    font-style: italic;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group:last-child {
    margin-bottom: 0;
  }

  .feature-badge {
    display: inline-block;
    background: #e8f5e8;
    color: #27ae60;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    margin-left: 8px;
  }

  .content-editor {
    width: 100%;
    min-height: 200px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.6;
    background-color: white;
    overflow-y: auto;
    transition: border-color 0.3s, box-shadow 0.3s;
  }

  .editor-help {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 10px;
    background: #e8f4fd;
    border-radius: 6px;
    font-size: 12px;
    color: #2980b9;
  }

  .help-icon {
    font-size: 14px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
  }

  input, textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }

  small {
    display: block;
    margin-top: 5px;
    color: #7f8c8d;
    font-size: 12px;
  }

  .required {
    color: #e74c3c;
    font-weight: bold;
  }

  /* Mejoras de accesibilidad */
  input:invalid {
    border-color: #e74c3c;
  }

  input:valid {
    border-color: #27ae60;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #3498db;
  }

  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 30px;
  }

  @media (max-width: 480px) {
    .actions {
      flex-direction: column;
      gap: 8px;
    }
  }

  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    font-size: 14px;
    min-height: 44px; /* Mejora accesibilidad t√°ctil */
  }

  @media (max-width: 480px) {
    .btn {
      width: 100%;
      padding: 15px 20px;
    }
  }

  .btn-primary {
    background: #3498db;
    color: white;
  }

  .btn-primary:hover {
    background: #2980b9;
  }

  .btn-success {
    background: #27ae60;
    color: white;
  }

  .btn-success:hover {
    background: #219a52;
  }

  .btn-secondary {
    background: #95a5a6;
    color: white;
  }

  .btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .btn-primary:hover {
    background: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
  }

  .btn-success:hover {
    background: #219a52;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
  }

  /* Estados de focus mejorados */
  .btn:focus {
    outline: 2px solid #3498db;
    outline-offset: 2px;
  }

  /* Animaciones suaves */
  .btn, input, .content-editor {
    transition: all 0.3s ease;
  }

  /* Mejoras visuales para inputs */
  input:focus {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.15);
  }

  /* Estados de validaci√≥n mejorados */
  input:valid:not(:placeholder-shown) {
    border-color: #27ae60;
    box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.1);
  }

  input:invalid:not(:placeholder-shown) {
    border-color: #e74c3c;
    box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.1);
  }

  .contact-section {
    background-color: #5f9b02;
    color: white;
  }

  /* Estilos para contenteditable */
  [contenteditable="true"]:empty:before {
    content: attr(data-placeholder);
    color: #999;
    font-style: italic;
  }

  [contenteditable="true"]:focus:before {
    content: "";
  }

  [contenteditable="true"] {
    outline: none;
  }

  [contenteditable="true"]:focus {
    border-color: #3498db !important;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
  }
</style>

<script>
  // Funci√≥n para procesar contenido y preservar HTML de tablas
  function processContent(content: string): string {
    if (!content) return '';
    
    // Detectar si el contenido contiene HTML de tabla
    const hasTable = /<table[\s\S]*?<\/table>/i.test(content);
    
    if (hasTable) {
      // Si contiene tablas, procesar el HTML y aplicar estilos para email
      return content.replace(/<table([^>]*)>/gi, (match, attributes) => {
        // Agregar atributos necesarios para compatibilidad con email si no existen
        let tableTag = '<table';
        if (!attributes.includes('cellpadding')) tableTag += ' cellpadding="0"';
        if (!attributes.includes('cellspacing')) tableTag += ' cellspacing="0"';
        if (!attributes.includes('border')) tableTag += ' border="1"';
        if (!attributes.includes('style')) {
          tableTag += ' style="border-collapse: collapse; width: 100%; margin: 10px 0; font-family: Inter, Arial, sans-serif;"';
        }
        tableTag += attributes + '>';
        return tableTag;
      })
      .replace(/<th([^>]*)>/gi, '<th$1 style="border: 1px solid #ddd; padding: 8px 12px; background-color: rgb(142, 288, 4); color: white; font-weight: bold; text-align: left;">')
      .replace(/<td([^>]*)>/gi, '<td$1 style="border: 1px solid #ddd; padding: 8px 12px; text-align: left;">')
      .replace(/\n/g, '<br>');
    } else {
      // Si no contiene tablas, solo reemplazar saltos de l√≠nea
      return content.replace(/\n/g, '<br>');
    }
  }

  // Plantilla moderna √∫nica con colores de QWASI
  const template = { 
    headerBg: 'rgb(142, 288, 4)', 
    font: 'Inter, system-ui, -apple-system, sans-serif',
    buttonBg: 'rgb(120, 240, 0)',
    textColor: '#000000',
    accentColor: 'rgb(100, 200, 0)'
  };

  function updatePreview() {
    const form = document.getElementById('newsletter-form') as HTMLFormElement;
    const formData = new FormData(form);
    const content = Object.fromEntries(formData);
    
    // Obtener contenido del div contenteditable
    const contentDiv = document.getElementById('content') as HTMLDivElement;
    if (contentDiv) {
      content.content = contentDiv.innerHTML;
    }
    
    const html = generateEmailHTML(content, template);
    
    const previewElement = document.getElementById('email-preview');
    if (previewElement) {
      previewElement.innerHTML = html;
    }
    return html;
  }

  function generateEmailHTML(content: {
    subject?: string;
    salutation?: string;
    title?: string;
    content?: string;
    imageUrl?: string;
    ctaText?: string;
    ctaUrl?: string;
    closing?: string;
    signature?: string;
  }, template: {
    headerBg: string;
    font: string;
    buttonBg: string;
    textColor: string;
  }) {
    const imageSection = content.imageUrl ? 
      `<tr>
        <td style="text-align: center; padding: 20px 0;">
          <img src="${content.imageUrl}" alt="Imagen del bolet√≠n" style="max-width: 100%; height: auto; display: block;">
        </td>
      </tr>` : '';

    const ctaSection = (content.ctaText && content.ctaUrl) ? 
      `<tr>
        <td style="text-align: center; padding: 30px 0;">
          <table cellpadding="0" cellspacing="0" border="0" style="margin: 0 auto;">
            <tr>
              <td style="background: ${template.buttonBg}; padding: 12px 24px; border-radius: 6px;">
                <a href="${content.ctaUrl}" style="color: white; text-decoration: none; font-weight: bold; display: block;">${content.ctaText}</a>
              </td>
            </tr>
          </table>
        </td>
      </tr>` : '';

    return `
      <table cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width: 600px; margin: 0 auto; font-family: ${template.font}; background: white;">
        <!-- Header -->
        <tr>
          <td style="padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;">
           <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="20.9117mm" height="8.6746mm" version="1.1" style="shape-rendering:geometricPrecision; text-rendering:geometricPrecision; image-rendering:optimizeQuality; fill-rule:evenodd; clip-rule:evenodd"
viewBox="0 0 216.83 89.95"
 xmlns:xlink="http://www.w3.org/1999/xlink"
 xmlns:xodm="http://www.corel.com/coreldraw/odm/2003">
 <defs>
  <style type="text/css">
   <![CDATA[
    .fil5 {fill:black;fill-rule:nonzero}
    .fil3 {fill:#FEFEFE}
    .fil1 {fill:black}
    .fil4 {fill:#00A2A9}
    .fil2 {fill:#70BA89}
    .fil0 {fill:#8EE404}
   ]]>
  </style>
 </defs>
 <g id="Layer_x0020_1">
  <metadata id="CorelCorpID_0Corel-Layer"/>
  <path class="fil0" d="M28.86 57.72c6.24,0 12.02,-1.98 16.75,-5.35l17.08 14.82 7.12 -8.22 -16.68 -14.47c2.91,-4.51 4.6,-9.87 4.6,-15.63 0,-15.94 -12.92,-28.86 -28.86,-28.86 -15.94,0 -28.86,12.92 -28.86,28.86 0,15.94 12.92,28.86 28.86,28.86z"/>
  <path class="fil1" d="M28.86 47.91c10.52,0 19.05,-8.53 19.05,-19.05 0,-2.5 -0.48,-4.89 -1.36,-7.08l-0.03 -0.07c-2.83,-6.98 -9.67,-11.91 -17.66,-11.91 -9.09,0 -16.69,6.36 -18.59,14.88l-0.1 0.5c-0.23,1.19 -0.35,2.41 -0.35,3.67 0,10.52 8.53,19.05 19.05,19.05z"/>
  <path class="fil2" d="M43.76 20.04c-3.02,-5.08 -8.56,-8.49 -14.9,-8.49 -7.65,0 -14.14,4.96 -16.43,11.83 4.42,-2.71 8.99,-5.51 14.34,-5.69 3.09,-0.1 5.73,0.72 8.12,1.94 1.09,-0.42 2.19,-0.75 3.28,-0.98 1.92,-0.4 3.87,0.41 5.6,1.39z"/>
  <path class="fil3" d="M46.33 29.49c0.25,-1.57 -0.44,-4.26 -0.98,-5.94 -0.33,-0.2 -0.69,-0.42 -1.07,-0.66 -1.75,-1.1 -3.94,-2.48 -5.66,-2.12 -0.4,0.08 -0.8,0.18 -1.2,0.3 1.05,0.67 2.06,1.38 3.05,2.08 0.61,0.43 1.22,0.86 1.85,1.29l-1.22 1.81c-0.6,-0.4 -1.24,-0.86 -1.89,-1.31 -1.42,-1 -2.88,-2.04 -4.45,-2.91 -2.54,1.07 -5.14,2.57 -7.74,4.07 -1.64,0.95 -3.28,1.89 -4.94,2.76l-1 -1.93c1.59,-0.83 3.22,-1.77 4.85,-2.7 2.09,-1.2 4.17,-2.41 6.25,-3.41 -1.64,-0.63 -3.41,-1.01 -5.33,-0.94 -4.78,0.16 -9.12,2.82 -13.3,5.39 -0.57,0.35 -1.14,0.7 -1.82,1.11 -0.12,0.82 -0.18,1.65 -0.18,2.5 0,1.04 0.09,2.06 0.27,3.05 5.37,-2.89 12.68,-1.41 19.49,-0.03 5.82,1.18 11.64,2.07 14.61,0.16l0.41 -2.55z"/>
  <path class="fil4" d="M43.59 37.98c0.61,-0.98 1.12,-2.02 1.53,-3.12 -3.69,1.28 -8.81,0.25 -14.23,-0.85 -6.67,-1.35 -13.82,-2.8 -18.53,0.1 0.2,0.63 0.43,1.24 0.7,1.83 3.47,-1.25 8.62,-0.26 14.21,0.81 5.55,1.07 11.56,2.22 16.33,1.23z"/>
  <path class="fil3" d="M38.23 43.43c1.3,-0.84 2.48,-1.84 3.51,-2.99 -4.68,0.41 -9.96,-0.61 -14.89,-1.55 -5.12,-0.98 -9.85,-1.89 -12.77,-0.99 0.91,1.48 2.03,2.81 3.33,3.96 6.99,-2.44 13.04,-0.68 19.79,1.28l1.03 0.3z"/>
  <path class="fil5" d="M211.37 16.29c-1.58,0 -2.88,-0.53 -3.91,-1.59 -1.03,-1.06 -1.55,-2.37 -1.55,-3.95 0,-1.53 0.52,-2.83 1.55,-3.91 1.03,-1.08 2.34,-1.62 3.91,-1.62 1.62,0 2.94,0.54 3.95,1.62 1.01,1.08 1.51,2.39 1.51,3.91 0,1.58 -0.5,2.89 -1.51,3.95 -1.01,1.06 -2.33,1.59 -3.95,1.59z"/>
  <polygon class="fil5" points="206.5,57.7 206.5,22.04 216.24,22.04 216.24,57.7 "/>
  <path class="fil5" d="M185.97 58.51c-2.02,0 -4,-0.27 -5.94,-0.81 -1.94,-0.54 -3.73,-1.29 -5.35,-2.25 -1.62,-0.96 -3.03,-2.13 -4.21,-3.51l5.76 -5.83c1.23,1.38 2.66,2.41 4.28,3.1 1.62,0.69 3.42,1.03 5.39,1.03 1.58,0 2.77,-0.22 3.58,-0.66 0.81,-0.44 1.22,-1.11 1.22,-1.99 0,-0.98 -0.43,-1.75 -1.29,-2.29 -0.86,-0.54 -1.98,-1 -3.36,-1.37 -1.38,-0.37 -2.82,-0.79 -4.32,-1.25 -1.5,-0.47 -2.94,-1.08 -4.32,-1.85 -1.38,-0.76 -2.5,-1.82 -3.36,-3.17 -0.86,-1.35 -1.29,-3.11 -1.29,-5.28 0,-2.26 0.55,-4.23 1.66,-5.91 1.11,-1.67 2.69,-2.98 4.76,-3.91 2.07,-0.94 4.5,-1.4 7.31,-1.4 2.95,0 5.62,0.52 8.01,1.55 2.39,1.03 4.37,2.58 5.94,4.65l-5.83 5.83c-1.08,-1.33 -2.3,-2.29 -3.65,-2.88 -1.35,-0.59 -2.82,-0.89 -4.39,-0.89 -1.43,0 -2.52,0.22 -3.29,0.66 -0.76,0.44 -1.14,1.06 -1.14,1.85 0,0.89 0.43,1.58 1.29,2.07 0.86,0.49 1.98,0.92 3.36,1.29 1.38,0.37 2.82,0.79 4.32,1.26 1.5,0.47 2.93,1.12 4.28,1.96 1.35,0.84 2.46,1.94 3.32,3.32 0.86,1.38 1.29,3.15 1.29,5.32 0,3.49 -1.25,6.26 -3.76,8.31 -2.51,2.04 -5.93,3.06 -10.26,3.06z"/>
  <polygon class="fil5" points="155.56,57.7 155.56,48.1 157.11,39.39 155.56,30.83 155.56,22.04 165.15,22.04 165.15,57.7 "/>
  <path class="fil5" d="M145.22 58.44c-3.25,0 -6.18,-0.81 -8.79,-2.44 -2.61,-1.62 -4.65,-3.84 -6.13,-6.64 -1.48,-2.81 -2.21,-5.95 -2.21,-9.45 0,-3.54 0.74,-6.72 2.21,-9.52 1.48,-2.81 3.52,-5.02 6.13,-6.64 2.61,-1.62 5.54,-2.44 8.79,-2.44 2.56,0 4.85,0.52 6.87,1.55 2.02,1.03 3.63,2.47 4.84,4.32 1.21,1.85 1.86,3.92 1.96,6.24l0 12.85c-0.1,2.36 -0.75,4.45 -1.96,6.27 -1.2,1.82 -2.82,3.26 -4.84,4.32 -2.02,1.06 -4.31,1.59 -6.87,1.59zm1.77 -8.93c2.71,0 4.9,-0.9 6.57,-2.69 1.67,-1.8 2.51,-4.12 2.51,-6.98 0,-1.87 -0.38,-3.53 -1.14,-4.98 -0.76,-1.45 -1.82,-2.58 -3.17,-3.4 -1.35,-0.81 -2.94,-1.22 -4.76,-1.22 -1.77,0 -3.33,0.41 -4.69,1.22 -1.35,0.81 -2.41,1.94 -3.17,3.4 -0.76,1.45 -1.14,3.11 -1.14,4.98 0,1.92 0.38,3.61 1.14,5.06 0.76,1.45 1.82,2.58 3.17,3.4 1.35,0.81 2.92,1.22 4.69,1.22z"/>
  <polygon class="fil5" points="76.12,57.7 59.29,5.8 69.18,5.8 81.66,45.74 78.34,45.74 90.59,5.8 98.05,5.8 110.3,45.74 106.91,45.74 119.46,5.8 129.35,5.8 112.44,57.7 104.99,57.7 92.66,17.84 95.91,17.84 83.65,57.7 "/>
  <path class="fil5" d="M196.87 84.38c-0.75,0 -1.49,-0.1 -2.21,-0.3 -0.72,-0.2 -1.39,-0.48 -1.99,-0.84 -0.6,-0.36 -1.13,-0.79 -1.56,-1.3l2.14 -2.17c0.46,0.51 0.99,0.9 1.59,1.15 0.6,0.26 1.27,0.38 2,0.38 0.59,0 1.03,-0.08 1.33,-0.25 0.3,-0.16 0.45,-0.41 0.45,-0.74 0,-0.37 -0.16,-0.65 -0.48,-0.85 -0.32,-0.2 -0.74,-0.37 -1.25,-0.51 -0.51,-0.14 -1.05,-0.29 -1.61,-0.47 -0.56,-0.17 -1.09,-0.4 -1.61,-0.69 -0.51,-0.28 -0.93,-0.68 -1.25,-1.18 -0.32,-0.5 -0.48,-1.16 -0.48,-1.96 0,-0.84 0.21,-1.57 0.62,-2.2 0.41,-0.62 1,-1.11 1.77,-1.45 0.77,-0.35 1.67,-0.52 2.72,-0.52 1.1,0 2.09,0.19 2.98,0.58 0.89,0.38 1.62,0.96 2.21,1.73l-2.17 2.17c-0.4,-0.49 -0.85,-0.85 -1.36,-1.07 -0.5,-0.22 -1.05,-0.33 -1.63,-0.33 -0.53,0 -0.94,0.08 -1.22,0.25 -0.28,0.16 -0.43,0.39 -0.43,0.69 0,0.33 0.16,0.59 0.48,0.77 0.32,0.18 0.74,0.34 1.25,0.48 0.51,0.14 1.05,0.29 1.6,0.47 0.56,0.17 1.09,0.42 1.59,0.73 0.5,0.31 0.91,0.72 1.23,1.23 0.32,0.51 0.48,1.17 0.48,1.98 0,1.3 -0.47,2.33 -1.4,3.09 -0.93,0.76 -2.2,1.14 -3.81,1.14z"/>
  <path class="fil5" d="M182.93 84.35c-1.34,0 -2.54,-0.31 -3.61,-0.92 -1.07,-0.61 -1.92,-1.44 -2.55,-2.5 -0.63,-1.05 -0.95,-2.23 -0.95,-3.53 0,-1.3 0.31,-2.46 0.93,-3.5 0.62,-1.03 1.47,-1.86 2.55,-2.47 1.08,-0.61 2.28,-0.92 3.59,-0.92 1.35,0 2.57,0.31 3.64,0.92 1.07,0.61 1.92,1.44 2.54,2.47 0.62,1.03 0.93,2.2 0.93,3.5 0,1.3 -0.31,2.47 -0.93,3.53 -0.62,1.05 -1.47,1.88 -2.54,2.5 -1.07,0.61 -2.27,0.92 -3.61,0.92zm-0.03 -3.35c0.68,0 1.28,-0.15 1.8,-0.45 0.52,-0.3 0.92,-0.72 1.21,-1.26 0.28,-0.54 0.43,-1.16 0.43,-1.85 0,-0.69 -0.15,-1.31 -0.44,-1.84 -0.29,-0.53 -0.69,-0.95 -1.21,-1.25 -0.51,-0.3 -1.11,-0.45 -1.78,-0.45 -0.66,0 -1.24,0.15 -1.76,0.45 -0.51,0.3 -0.91,0.72 -1.21,1.25 -0.29,0.53 -0.44,1.14 -0.44,1.84 0,0.69 0.15,1.31 0.44,1.85 0.29,0.54 0.69,0.96 1.21,1.26 0.51,0.3 1.1,0.45 1.76,0.45z"/>
  <path class="fil5" d="M173.52 84.08l-3.57 0 0 -1.2c-0.35,0.34 -0.75,0.63 -1.21,0.88 -0.77,0.4 -1.63,0.6 -2.58,0.6 -1.23,0 -2.32,-0.3 -3.29,-0.91 -0.97,-0.6 -1.73,-1.43 -2.29,-2.47 -0.56,-1.04 -0.84,-2.21 -0.84,-3.51 0,-1.32 0.28,-2.5 0.84,-3.54 0.56,-1.04 1.32,-1.87 2.28,-2.47 0.96,-0.6 2.06,-0.91 3.31,-0.91 0.95,0 1.81,0.19 2.57,0.58 0.45,0.23 0.85,0.51 1.19,0.84l0 -7.72 3.59 0 0 19.83zm-6.75 -3.05c0.68,0 1.27,-0.15 1.77,-0.45 0.5,-0.3 0.9,-0.72 1.18,-1.26 0.28,-0.54 0.43,-1.17 0.43,-1.88 0,-0.69 -0.14,-1.31 -0.43,-1.85 -0.28,-0.54 -0.68,-0.96 -1.18,-1.26 -0.5,-0.3 -1.08,-0.45 -1.74,-0.45 -0.68,0 -1.27,0.16 -1.77,0.47 -0.5,0.31 -0.9,0.73 -1.18,1.26 -0.28,0.53 -0.43,1.14 -0.43,1.84 0,0.71 0.14,1.34 0.43,1.88 0.28,0.54 0.68,0.96 1.19,1.26 0.51,0.3 1.09,0.45 1.73,0.45z"/>
  <path class="fil5" d="M153.82 84.08l0 -1.28c-0.36,0.38 -0.79,0.71 -1.29,0.96 -0.75,0.39 -1.6,0.59 -2.55,0.59 -1.21,0 -2.3,-0.3 -3.26,-0.91 -0.97,-0.6 -1.73,-1.43 -2.28,-2.47 -0.55,-1.04 -0.82,-2.21 -0.82,-3.51 0,-1.32 0.27,-2.5 0.82,-3.54 0.55,-1.04 1.31,-1.87 2.28,-2.47 0.97,-0.6 2.06,-0.91 3.26,-0.91 0.95,0 1.8,0.19 2.55,0.58 0.5,0.25 0.92,0.57 1.29,0.96l0 -1.26 3.57 0 0 13.25 -3.57 0zm-3.18 -3.05c1.01,0 1.82,-0.33 2.44,-1 0.62,-0.67 0.93,-1.53 0.93,-2.59 0,-0.69 -0.14,-1.31 -0.43,-1.85 -0.28,-0.54 -0.68,-0.96 -1.18,-1.26 -0.5,-0.3 -1.09,-0.45 -1.77,-0.45 -0.66,0 -1.24,0.15 -1.74,0.45 -0.5,0.3 -0.9,0.72 -1.18,1.26 -0.28,0.54 -0.43,1.16 -0.43,1.85 0,0.71 0.14,1.34 0.43,1.88 0.28,0.54 0.68,0.96 1.18,1.26 0.5,0.3 1.08,0.45 1.74,0.45z"/>
  <path class="fil5" d="M134.1 89.95c-1.41,0 -2.65,-0.25 -3.73,-0.75 -1.08,-0.5 -1.94,-1.21 -2.58,-2.13l2.28 -2.28c0.51,0.6 1.08,1.06 1.71,1.39 0.63,0.32 1.39,0.48 2.29,0.48 1.12,0 2,-0.28 2.65,-0.85 0.65,-0.57 0.97,-1.35 0.97,-2.36l0 -1.1c-0.34,0.32 -0.72,0.59 -1.17,0.81 -0.76,0.37 -1.62,0.56 -2.59,0.56 -1.19,0 -2.26,-0.29 -3.21,-0.86 -0.95,-0.58 -1.7,-1.37 -2.24,-2.37 -0.54,-1.01 -0.81,-2.13 -0.81,-3.37 0,-1.24 0.27,-2.36 0.81,-3.35 0.54,-0.99 1.29,-1.77 2.24,-2.35 0.95,-0.58 2.02,-0.86 3.21,-0.86 0.99,0 1.86,0.19 2.62,0.58 0.44,0.22 0.83,0.5 1.17,0.82l0 -1.12 3.57 0 0 12.57c0,1.32 -0.31,2.46 -0.92,3.44 -0.61,0.98 -1.46,1.74 -2.54,2.29 -1.08,0.55 -2.32,0.82 -3.73,0.82zm0.55 -9.49c0.66,0 1.23,-0.14 1.72,-0.43 0.48,-0.28 0.86,-0.68 1.14,-1.18 0.27,-0.5 0.41,-1.08 0.41,-1.72 0,-0.66 -0.14,-1.23 -0.41,-1.73 -0.27,-0.49 -0.65,-0.88 -1.14,-1.17 -0.49,-0.28 -1.06,-0.43 -1.72,-0.43 -0.66,0 -1.23,0.14 -1.73,0.43 -0.49,0.28 -0.88,0.68 -1.15,1.18 -0.27,0.5 -0.41,1.07 -0.41,1.71 0,0.62 0.14,1.18 0.41,1.69 0.27,0.5 0.66,0.9 1.15,1.19 0.49,0.29 1.07,0.44 1.73,0.44z"/>
  <path class="fil5" d="M119.18 84.35c-1.34,0 -2.54,-0.31 -3.61,-0.92 -1.07,-0.61 -1.92,-1.44 -2.55,-2.5 -0.63,-1.05 -0.95,-2.23 -0.95,-3.53 0,-1.3 0.31,-2.46 0.93,-3.5 0.62,-1.03 1.47,-1.86 2.55,-2.47 1.08,-0.61 2.28,-0.92 3.59,-0.92 1.35,0 2.57,0.31 3.64,0.92 1.07,0.61 1.92,1.44 2.54,2.47 0.62,1.03 0.93,2.2 0.93,3.5 0,1.3 -0.31,2.47 -0.93,3.53 -0.62,1.05 -1.47,1.88 -2.54,2.5 -1.07,0.61 -2.27,0.92 -3.61,0.92zm-0.03 -3.35c0.68,0 1.28,-0.15 1.8,-0.45 0.52,-0.3 0.92,-0.72 1.21,-1.26 0.28,-0.54 0.43,-1.16 0.43,-1.85 0,-0.69 -0.15,-1.31 -0.44,-1.84 -0.29,-0.53 -0.69,-0.95 -1.21,-1.25 -0.51,-0.3 -1.11,-0.45 -1.78,-0.45 -0.66,0 -1.24,0.15 -1.76,0.45 -0.51,0.3 -0.91,0.72 -1.21,1.25 -0.29,0.53 -0.44,1.14 -0.44,1.84 0,0.69 0.15,1.31 0.44,1.85 0.29,0.54 0.69,0.96 1.21,1.26 0.51,0.3 1.1,0.45 1.76,0.45z"/>
  <path class="fil5" d="M96.82 84.08l0 -19.83 3.59 0 0 7.73c0.35,-0.33 0.75,-0.61 1.21,-0.84 0.77,-0.38 1.62,-0.58 2.55,-0.58 1.23,0 2.32,0.3 3.29,0.91 0.97,0.6 1.73,1.43 2.29,2.47 0.56,1.04 0.84,2.22 0.84,3.54 0,1.3 -0.28,2.47 -0.84,3.51 -0.56,1.04 -1.32,1.87 -2.29,2.47 -0.97,0.6 -2.07,0.91 -3.29,0.91 -0.95,0 -1.81,-0.2 -2.58,-0.6 -0.46,-0.24 -0.86,-0.53 -1.21,-0.88l0 1.2 -3.57 0zm6.75 -3.05c0.66,0 1.24,-0.15 1.74,-0.45 0.5,-0.3 0.9,-0.72 1.18,-1.26 0.28,-0.54 0.43,-1.17 0.43,-1.88 0,-0.69 -0.14,-1.31 -0.43,-1.85 -0.28,-0.54 -0.68,-0.96 -1.19,-1.26 -0.51,-0.3 -1.1,-0.45 -1.76,-0.45 -0.66,0 -1.24,0.15 -1.74,0.45 -0.5,0.3 -0.9,0.72 -1.18,1.26 -0.28,0.54 -0.43,1.16 -0.43,1.85 0,0.71 0.14,1.34 0.43,1.88 0.28,0.54 0.68,0.96 1.19,1.26 0.51,0.3 1.1,0.45 1.76,0.45z"/>
  <path class="fil5" d="M76.16 84.08l7.76 -19.29 3.05 0 7.74 19.29 -3.98 0 -1.36 -3.59 -7.94 0 -1.38 3.59 -3.9 0zm12.03 -6.72l-2.76 -7.3 -2.8 7.3 5.56 0z"/>
 </g>
</svg>

            <h1 style="margin: 0; color: #000000; font-size: 24px; font-weight: bold;">Bolet√≠n Legal</h1>
          </td>
        </tr>
        <!-- Divider -->
        <tr>
          <td style="height: 2px; background-color: ${template.headerBg};"></td>
        </tr>
        <!-- Content -->
        <tr>
          <td style="padding: 30px; line-height: 1.6; color: ${template.textColor};">
            <table cellpadding="0" cellspacing="0" border="0" width="100%">
              <!-- Salutation -->
              <tr>
                <td style="padding-bottom: 20px;">
                  <strong>${content.salutation || 'Estimados colaboradores,'}</strong>
                </td>
              </tr>
              
              <!-- Title -->
              ${content.title ? `<tr>
                <td style="padding-bottom: 20px;">
                  <h2 style="color: #000000; margin: 0; font-size: 20px;">${content.title}</h2>
                </td>
              </tr>` : ''}
              
              <!-- Image -->
              ${imageSection}
              
              <!-- Main Content -->
              <tr>
                <td style="padding: 20px 0;">
                  <div style="line-height: 1.6;">
                    ${processContent(content.content || '')}
                  </div>
                </td>
              </tr>
              
              <!-- CTA Button -->
              ${ctaSection}
              
              <!-- Closing -->
              <tr>
                <td style="padding-top: 30px; border-top: 1px solid #ddd;">
                  <strong>Saludos cordiales del Equipo de QWASI</strong>
                </td>
              </tr>
            </table>
          </td>
        </tr>
        
        <!-- Footer -->
        <tr>
          <td style="background: #5f9b02; padding: 20px; text-align: center; color: white; font-size: 14px;">
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="margin: 0 auto;">
              <tr>
                <td style="width: 33.33%; text-align: center; padding: 5px;">
                  üìß <a href="mailto:legal@quwasi.com" style="color: white; text-decoration: none;">legal@quwasi.com</a>
                </td>
                <td style="width: 33.33%; text-align: center; padding: 5px;">
                  üåê <a href="https://www.quwasi.com" style="color: white; text-decoration: none;">www.quwasi.com</a>
                </td>
                <td style="width: 33.33%; text-align: center; padding: 5px;">
                  üì± <a href="tel:+51943440165" style="color: white; text-decoration: none;">+51 943 440 165</a>
                </td>
              </tr>
            </table>
            <div style="font-size: 12px; color: white; margin-top: 15px;">
              ¬© ${new Date().getFullYear()} QWASI. Todos los derechos reservados.
            </div>
          </td>
        </tr>
      </table>
    `;
  }

  async function copyToClipboard() {
    try {
      const previewElement = document.getElementById('email-preview');
      if (!previewElement) {
        showNotification('‚ùå Error: No se encontr√≥ la vista previa');
        return;
      }

      // Clonar el elemento para modificarlo sin afectar la vista previa
      const clonedElement = previewElement.cloneNode(true) as HTMLElement;
      
      // Convertir SVGs a im√°genes base64 para mejor compatibilidad con email
      const svgElements = clonedElement.querySelectorAll('svg');
      for (const svg of svgElements) {
        try {
          // Crear un canvas para convertir SVG a imagen
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const svgData = new XMLSerializer().serializeToString(svg);
          
          // Obtener dimensiones del SVG
          const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(svgBlob);
          
          const img = new Image();
          img.onload = function() {
            canvas.width = img.width || 200;
            canvas.height = img.height || 80;
            ctx?.drawImage(img, 0, 0);
            
            // Convertir a base64
            const base64 = canvas.toDataURL('image/png');
            
            // Reemplazar SVG con imagen
            const imgElement = document.createElement('img');
            imgElement.src = base64;
            imgElement.style.height = svg.style.height || '40px';
            imgElement.style.width = 'auto';
            imgElement.alt = 'Logo';
            
            svg.parentNode?.replaceChild(imgElement, svg);
            URL.revokeObjectURL(url);
          };
          img.src = url;
          
          // Esperar un poco para que se procese la imagen
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (svgError) {
          console.warn('Error procesando SVG:', svgError);
          // Si falla, mantener el SVG original pero simplificado
          svg.innerHTML = svg.innerHTML.replace(/<defs>[\s\S]*?<\/defs>/g, '');
          svg.innerHTML = svg.innerHTML.replace(/<!\[CDATA\[[\s\S]*?\]\]>/g, '');
        }
      }

      // Usar la API moderna de clipboard para copiar con formato
      if (navigator.clipboard && navigator.clipboard.write) {
        const data = new ClipboardItem({
          'text/html': new Blob([clonedElement.innerHTML], { type: 'text/html' }),
          'text/plain': new Blob([clonedElement.innerText], { type: 'text/plain' })
        });
        await navigator.clipboard.write([data]);
        showNotification('‚úÖ Email copiado con formato (logo incluido)');
      } else {
        // Fallback: crear selecci√≥n temporal del elemento clonado
        document.body.appendChild(clonedElement);
        clonedElement.style.position = 'absolute';
        clonedElement.style.left = '-9999px';
        
        const range = document.createRange();
        range.selectNodeContents(clonedElement);
        
        const selection = window.getSelection();
        selection?.removeAllRanges();
        selection?.addRange(range);
        
        document.execCommand('copy');
        selection?.removeAllRanges();
        document.body.removeChild(clonedElement);
        
        showNotification('‚úÖ Email copiado con formato (logo incluido)');
      }
      
    } catch (err) {
      console.error('Error al copiar:', err);
      // Fallback final: copiar solo texto
      try {
        const previewElement = document.getElementById('email-preview');
        const textContent = previewElement ? previewElement.innerText : '';
        await navigator.clipboard.writeText(textContent);
        showNotification('‚úÖ Email copiado como texto');
      } catch (fallbackErr) {
        showNotification('‚ùå Error al copiar el contenido');
      }
    }
  }

  function clearForm() {
    if (confirm('¬øLimpiar todo el formulario?')) {
      const form = document.getElementById('newsletter-form') as HTMLFormElement;
      if (form) {
        form.reset();
      }
      updatePreview();
    }
  }

  function showNotification(message: string) {
    // Crear notificaci√≥n toast simple
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 6px;
      z-index: 1000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Actualizaci√≥n autom√°tica en tiempo real
  function setupRealTimePreview() {
    const form = document.getElementById('newsletter-form');
    if (form) {
      form.addEventListener('input', updatePreview);
      form.addEventListener('change', updatePreview);
    }
  }

  // Exponer funci√≥n globalmente para el bot√≥n de EmailPreview
  (window as any).copyToClipboard = copyToClipboard;

  // Agregar eventos para el contenteditable
  document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    setupRealTimePreview();
    
    const contentDiv = document.getElementById('content') as HTMLDivElement;
    if (contentDiv) {
      // Actualizar vista previa cuando cambie el contenido
      contentDiv.addEventListener('input', updatePreview);
      contentDiv.addEventListener('paste', function(e) {
        // Permitir pegar con formato
        setTimeout(updatePreview, 10);
      });
    }
  });
</script>