---
// src/components/newsletter/NewsletterForm.astro
import EmailPreview from "./EmailPreview.astro";

// Estado inicial
const initialContent = {
  subject: "",
  salutation: "Estimados,",
  closing: "Saludos cordiales,",
  signature: "El equipo de Comunicaciones",
};

// Tipos para TypeScript
interface BlockData {
  subtitle: string;
  description: string;
  linkTitle: string;
  link: string;
}
---

<div class="newsletter-app">
  <div class="editor-grid">
    <!-- Panel de Edici√≥n -->
    <div class="editor-panel">
      <form id="newsletter-form">
        <div class="form-section">
          <h3 class="section-title">
            <span class="icon">üìß</span> Informaci√≥n inicial
          </h3>

          <div class="form-row">
            <div class="form-group">
              <label for="salutation">Saludo Inicial</label>
              <div class="input-group">
                <input
                  type="text"
                  name="salutation"
                  value={initialContent.salutation}
                  placeholder="Ej: Estimados,"
                  maxlength="80"
                  autocomplete="off"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="closing">Despedida</label>
              <div class="input-group">
                <input
                  type="text"
                  name="closing"
                  value={initialContent.closing}
                  placeholder="Ej: Saludos cordiales,"
                  maxlength="80"
                  autocomplete="off"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="subject">
              T√≠tulo del Bolet√≠n
              <span class="required" aria-label="Campo obligatorio">*</span>
            </label>
            <div class="input-group">
              <input
                type="text"
                id="subject"
                name="subject"
                placeholder="Ej: Bolet√≠n Informativo del mes del a√±o"
                value={initialContent.subject}
                required
                aria-describedby="subject-help"
                maxlength="160"
                autocomplete="off"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="mainImageUrl">URL de Imagen Principal</label>
            <div class="input-group">
              <input
                type="url"
                id="mainImageUrl"
                name="mainImageUrl"
                placeholder="https://.../banner.jpg"
                inputmode="url"
                pattern="https?://.+"
                autocomplete="off"
              />
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-header">
            <h3 class="section-title">
              <span class="icon">üìù</span> Contenido
            </h3>
            <button
              type="button"
              class="btn btn-sm btn-success"
              onclick="addBlock()"
            >
              <span class="icon-plus">Ôºã</span> Agregar Bloque
            </button>
          </div>

          <div id="blocks-container"></div>
        </div>
      </form>

      <div class="actions-footer">
        <button type="button" class="btn btn-secondary" onclick="clearForm()">
          <span class="icon-trash">üóëÔ∏è</span> Limpiar Todo
        </button>
      </div>
    </div>

    <!-- Vista Previa -->
    <div class="preview-panel">
      <div class="preview-sticky">
        <div class="email-client-simulator">
          <div class="client-header">
            <div class="window-controls">
              <span class="control close"></span>
              <span class="control minimize"></span>
              <span class="control maximize"></span>
            </div>
            <div class="client-toolbar">
              <div class="client-info">
                <span class="label">De:</span>
                <span class="value">legal@quwasi.com</span>
              </div>
              <div class="client-info">
                <span class="label">Para:</span>
                <span class="value">Lista de Suscriptores</span>
              </div>
            </div>
            <div class="client-actions">
              <button
                type="button"
                class="btn btn-primary btn-copy"
                onclick="copyToClipboard()"
              >
                <span class="icon">üìã</span> Copiar HTML
              </button>
            </div>
          </div>
          <div class="client-body">
            <EmailPreview />
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de la plantilla
    const template = {
      headerBg: "#1B5E20",
      font: "Arial, Helvetica, sans-serif",
      buttonBg: "#43A047",
      textColor: "#333333",
      accentColor: "#2E7D32",
    };

    // Funci√≥n principal de actualizaci√≥n
    function updatePreview() {
      const form = document.getElementById(
        "newsletter-form",
      ) as HTMLFormElement;
      if (!form) return;

      const formData = new FormData(form);
      const content: any = Object.fromEntries(formData);

      // Recopilar bloques
      const blockNodes = Array.from(
        document.querySelectorAll(".block-item"),
      ) as HTMLElement[];
      const blocks = blockNodes
        .map((node) => {
          const titleInput = node.querySelector(
            'input[name="blockTitle"]',
          ) as HTMLInputElement;
          const descInput = node.querySelector(
            'textarea[name="blockDescription"]',
          ) as HTMLTextAreaElement;
          const descEl = node.querySelector(
            '[data-role="blockDescription"]',
          ) as HTMLElement | null;
          const linkInput = node.querySelector(
            'input[name="blockLink"]',
          ) as HTMLInputElement;
          const linkTitleInput = node.querySelector(
            'input[name="blockLinkTitle"]',
          ) as HTMLInputElement;

          const titleDisplay = node.querySelector(".block-title-text");
          if (titleDisplay) {
            titleDisplay.textContent = titleInput?.value || "Nuevo Bloque";
          }

          return {
            subtitle: titleInput?.value?.trim() || "",
            description: descEl
              ? sanitizeRichText(descEl.innerHTML)
              : descInput?.value || "",
            linkTitle: linkTitleInput?.value?.trim() || "",
            link: linkInput?.value?.trim() || "",
          };
        })
        .filter((b) => b.subtitle || b.description || b.link); // Incluir si tiene algo de contenido

      content.blocks = blocks;

      // Generar HTML
      const html = generateEmailHTML(content, template);

      const previewElement = document.getElementById("email-preview");
      if (previewElement) {
        previewElement.innerHTML = html;
      }

      // Mostrar/ocultar mensaje de estado vac√≠o
      const emptyState = document.getElementById("empty-blocks-msg");
      if (emptyState) {
        emptyState.style.display = blocks.length === 0 ? "block" : "none";
      }
    }

    // Generador de HTML para el Email
    function generateEmailHTML(content: any, template: any) {
      const blocksSection =
        content.blocks && content.blocks.length > 0
          ? `
      <tr>
        <td style="padding-top: 20px;">
          <h3 style="margin: 0 0 15px 0; font-family: ${template.font}; font-size: 18px; color: #2E7D32; border-bottom: 2px solid #4CAF50; padding-bottom: 5px;">Temas Destacados</h3>
          <table cellpadding="0" cellspacing="0" border="0" width="100%" style="font-family: ${template.font}; border-collapse: collapse;">
            ${content.blocks
              .map(
                (b: any) => `
              <tr>
                <td style="padding: 15px 0; border-bottom: 1px solid #EEEEEE; font-family: ${template.font};">
                  <strong style="color: #1a1a1a; font-family: ${template.font}; font-size: 16px; display: block; margin-bottom: 8px;">${b.subtitle || ""}</strong>
                  ${b.description ? `<div style="color: ${template.textColor}; font-family: ${template.font}; line-height: 1.6; margin-bottom: 10px;">${processContent(b.description)}</div>` : ""}
                  ${
                    b.link
                      ? `
                    <table cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                      <tr>
                        <td style="background-color: ${template.buttonBg}; border-radius: 4px; padding: 8px 16px;">
                          <a href="${b.link}" target="_blank" rel="noopener noreferrer" style="color: white; font-family: ${template.font}; text-decoration: none; font-size: 14px; display: block; font-weight: bold;">
                            ${b.linkTitle || "Leer m√°s ‚Üí"}
                          </a>
                        </td>
                      </tr>
                    </table>
                  `
                      : ""
                  }
                </td>
              </tr>
            `,
              )
              .join("")}
          </table>
        </td>
      </tr>
    `
          : "";

      return `
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
      <html xmlns="http://www.w3.org/1999/xhtml">
      <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>${content.subject || "Bolet√≠n"}</title>
        <style type="text/css">
          body { margin: 0; padding: 0; min-width: 100%; font-family: ${template.font}; }
          table { border-collapse: collapse; }
          td { font-family: ${template.font}; }
        </style>
      </head>
      <body style="margin: 0; padding: 0; background-color: #f4f4f4;">
        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background-color: #f4f4f4; border-collapse: collapse;">
          <tr>
            <td align="center" style="padding: 20px 0;">
              <table cellpadding="0" cellspacing="0" border="0" width="600" style="max-width: 600px; width: 100%; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.05); border-collapse: collapse;">
                <!-- Header -->
                <tr>
                  <td style="padding: 25px 30px; background-color: ${template.headerBg}; border-bottom: 3px solid ${template.accentColor};">
                    <table width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse: collapse;">
                        <tr>
                            <td align="left" style="width: 50%; vertical-align: middle;">
                                <img src="https://www.quwasi.com/wp-content/uploads/2020/04/Logo-QWasi-BLANCO.png" alt="QWASI" style="max-width: 150px; height: auto; display: block;" />
                            </td>
                            <td align="right" style="width: 50%; vertical-align: middle;">
                                <h1 style="margin: 0; font-family: ${template.font}; color: #ffffff; font-size: 24px; font-weight: 800;">Bolet√≠n Legal</h1>                       
                            </td>
                        </tr>
                    </table>
                  </td>
                </tr>
                
                <!-- Main Content -->
                <tr>
                  <td style="padding: 30px; line-height: 1.6; color: ${template.textColor}; font-family: ${template.font};">
                    <table cellpadding="0" cellspacing="0" border="0" width="100%" style="border-collapse: collapse;">
                      <!-- Salutation -->
                      <tr>
                        <td style="padding-bottom: 20px;">
                          <div style="font-size: 16px; font-family: ${template.font}; color: ${template.textColor};">${content.salutation || "Estimados,"}</div>
                        </td>
                      </tr>

                      <!-- Subject/Title -->
                      ${
                        content.subject
                          ? `
                      <tr>
                        <td style="padding-bottom: 20px;">
                            <h2 style="margin: 0; color: #333333; font-family: ${template.font}; font-size: 22px;">${content.subject}</h2>
                        </td>
                      </tr>`
                          : ""
                      }

                      <!-- Main Image -->
                      ${
                        content.mainImageUrl
                          ? `
                      <tr>
                        <td style="padding-bottom: 20px;">
                          <img src="${content.mainImageUrl}" alt="Imagen Principal" style="width: 100%; max-width: 100%; height: auto; display: block; border-radius: 4px;" />
                        </td>
                      </tr>`
                          : ""
                      }
                      
                      <!-- Blocks -->
                      ${blocksSection}
                      
                      <!-- Signature -->
                      <tr>
                        <td style="padding-bottom: 20px;">
                           <div style="font-size: 16px; font-family: ${template.font}; color: ${template.textColor};">${content.closing || "Saludos cordiales,"}</div>
                        </td>
                      </tr>
                      <tr>
                        <td style="padding-top: 40px; border-top: 1px solid #eee; margin-top: 20px;">
                          <strong style="color: ${template.accentColor}; font-family: ${template.font}; display: block; margin-top: 5px;">Equipo Legal QWASI</strong>
                        </td>
                      </tr>
                      
                    </table>
                  </td>
                </tr>
                
                <!-- Footer -->
                <tr>
                  <td style="background: #333333; padding: 30px; text-align: center; color: #bbbbbb; font-size: 13px; font-family: ${template.font};">
                    <p style="margin: 0 0 10px 0;">
                        <a href="mailto:legal@quwasi.com" style="color: white; text-decoration: none; margin: 0 10px;">legal@quwasi.com</a> | 
                        <a href="tel:+51943440165" style="color: white; text-decoration: none; margin: 0 10px;">+51 943 440 165</a>
                    </p>
                    <p style="margin: 0;">
                        <a href="https://www.qwasi.com" style="color: white; text-decoration: none;">www.qwasi.com</a>
                    </p>
                    <div style="opacity: 0.6; margin-top: 15px;">
                      ¬© ${new Date().getFullYear()} QWASI. Todos los derechos reservados.
                    </div>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </body>
      </html>
    `;
    }

    function processContent(content: string): string {
      if (!content) return "";
      return content.replace(/\n/g, "<br>");
    }

    function sanitizeRichText(html: string): string {
      if (!html) return "";
      return html.replace(/<(?!\/?(b|strong|i|em|u|br)\b)[^>]*>/gi, "");
    }

    // Gesti√≥n de Bloques
    function addBlock() {
      const container = document.getElementById("blocks-container");
      if (!container) return;

      const id = Date.now();
      const wrapper = document.createElement("div");
      wrapper.className = "block-item new";
      wrapper.id = `block-${id}`;
      wrapper.setAttribute(
        "style",
        "background: transparent; border: 1px solid var(--color-border); border-radius: var(--radius-md); box-shadow: none; overflow: hidden; margin-bottom: var(--spacing-md); transition: border-color .2s, transform .2s, opacity .2s;",
      );

      wrapper.insertAdjacentHTML(
        "afterbegin",
        `
      <div class="block-header" style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background: transparent; border-bottom:1px solid var(--color-border); cursor:pointer;">
        <span class="block-title-display" style="font-weight:600; color: var(--color-text-main);"><span class="block-title-text">Nuevo Bloque</span></span>
        <div class="block-controls" style="display:flex; align-items:center; gap:4px;">
            <button type="button" class="btn-icon" style="width:1.8rem; height:1.8rem; padding:.25rem .5rem; border:1px solid var(--color-border); border-radius: var(--radius-sm); background: transparent; cursor: pointer; color: var(--color-text-main);" data-action="move-up" title="Subir">‚Üë</button>
            <button type="button" class="btn-icon" style="height:1.8rem; padding:.25rem .5rem; border:1px solid var(--color-border); border-radius: var(--radius-sm); background: transparent; cursor: pointer; color: var(--color-text-main);" data-action="move-down" title="Bajar">‚Üì</button>
            <button type="button" class="btn-icon delete" style="height:1.8rem; padding:.25rem .5rem; border:1px solid var(--color-border); border-radius: var(--radius-sm); background: transparent; cursor: pointer; color: var(--color-text-main);" data-action="delete" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
      <div class="block-content" id="content-${id}" style="padding: var(--spacing-md);">
        <div class="form-group" style="margin: 0 0 var(--spacing-md) 0;">
            <label>T√≠tulo del Tema</label>
            <div class="input-group" style="display:flex; align-items:center; border:2px solid var(--color-border); border-radius: var(--radius-sm); background: transparent;">
              <input type="text" name="blockTitle" placeholder="Ej: Nuevas Regulaciones" required maxlength="120" autocomplete="off" style="border:none; outline:none; padding:12px; flex:1; background: white;" />
            </div>
        </div>
        <div class="form-group" style="margin: 0 0 var(--spacing-md) 0;">
            <label>Descripci√≥n</label>
            <div contenteditable="true" data-role="blockDescription" style="border:1px solid var(--color-border); border-radius: var(--radius-sm); padding:10px; background: white; outline: none; min-height: 80px; line-height: 1.5;"></div>
        </div>
        <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
            <div class="form-group" style="margin:0;">
                <label>T√≠tulo del link</label>
                <div class="input-group" style="display:flex; align-items:center; border:2px solid var(--color-border); border-radius: var(--radius-sm); background: transparent;">
                  <input type="text" name="blockLinkTitle" placeholder="Ej: Leer m√°s" maxlength="120" autocomplete="off" style="border:none; outline:none; padding:12px; flex:1; background: white;" />
                </div>
            </div>
            <div class="form-group" style="margin:0;">
                <label>Enlace (URL)</label>
                <div class="input-group" style="display:flex; align-items:center; border:2px solid var(--color-border); border-radius: var(--radius-sm); background: transparent;">
                  <input type="url" name="blockLink" placeholder="https://..." inputmode="url" pattern="https?://.+" style="border:none; outline:none; padding:12px; flex:1; background: white;" />
                </div>
            </div>
        </div>
      </div>
    `,
      );

      container.appendChild(wrapper);

      setTimeout(() => {
        wrapper.classList.remove("new");
      }, 150);

      const headerEl = wrapper.querySelector(
        ".block-header",
      ) as HTMLElement | null;
      if (headerEl) {
        headerEl.addEventListener("click", (e) => {
          const target = e.target as HTMLElement;
          if (!target.closest(".block-controls")) {
            toggleBlock(String(id));
          }
        });
      }

      const moveUpBtn = wrapper.querySelector(
        '[data-action="move-up"]',
      ) as HTMLElement | null;
      const moveDownBtn = wrapper.querySelector(
        '[data-action="move-down"]',
      ) as HTMLElement | null;
      const deleteBtn = wrapper.querySelector(
        '[data-action="delete"]',
      ) as HTMLElement | null;
      moveUpBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        moveBlock(String(id), -1);
      });
      moveDownBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        moveBlock(String(id), 1);
      });
      deleteBtn?.addEventListener("click", (e) => {
        e.stopPropagation();
        removeBlock(String(id));
      });

      const inputs = wrapper.querySelectorAll(
        "input, textarea, [data-role='blockDescription']",
      );
      inputs.forEach((inp) => inp.addEventListener("input", updatePreview));
      const urlInput = wrapper.querySelector(
        'input[name="blockLink"]',
      ) as HTMLInputElement | null;
      if (urlInput) {
        urlInput.addEventListener("input", () => {
          if (urlInput.value && !/^https?:\/\/.+/.test(urlInput.value)) {
            urlInput.setCustomValidity("URL inv√°lida. Use https://");
          } else {
            urlInput.setCustomValidity("");
          }
        });
      }

      updatePreview();
    }

    function removeBlock(id: string) {
      if (confirm("¬øEst√°s seguro de eliminar este bloque?")) {
        const block = document.getElementById(`block-${id}`);
        block?.remove();
        updatePreview();
      }
    }

    function moveBlock(id: string, direction: number) {
      const block = document.getElementById(`block-${id}`);
      const container = document.getElementById("blocks-container");
      if (!block || !container) return;

      if (direction === -1 && block.previousElementSibling) {
        container.insertBefore(block, block.previousElementSibling);
      } else if (direction === 1 && block.nextElementSibling) {
        container.insertBefore(block.nextElementSibling, block);
      }
      updatePreview();
    }

    function toggleBlock(id: string) {
      const content = document.getElementById(`content-${id}`);
      content?.classList.toggle("collapsed");
    }

    async function copyToClipboard() {
      try {
        const form = document.getElementById(
          "newsletter-form",
        ) as HTMLFormElement;
        const formData = new FormData(form);
        const content: any = Object.fromEntries(formData);

        // Reconstruir bloques para el contenido
        const blockNodes = Array.from(
          document.querySelectorAll(".block-item"),
        ) as HTMLElement[];
        const blocks = blockNodes
          .map((node) => {
            const titleInput = node.querySelector(
              'input[name="blockTitle"]',
            ) as HTMLInputElement;
            const descInput = node.querySelector(
              'textarea[name="blockDescription"]',
            ) as HTMLTextAreaElement;
            const descEl = node.querySelector(
              '[data-role="blockDescription"]',
            ) as HTMLElement | null;
            const linkInput = node.querySelector(
              'input[name="blockLink"]',
            ) as HTMLInputElement;
            const linkTitleInput = node.querySelector(
              'input[name="blockLinkTitle"]',
            ) as HTMLInputElement;
            return {
              subtitle: titleInput?.value?.trim() || "",
              description: descEl
                ? sanitizeRichText(descEl.innerHTML)
                : descInput?.value || "",
              linkTitle: linkTitleInput?.value?.trim() || "",
              link: linkInput?.value?.trim() || "",
            };
          })
          .filter((b) => b.subtitle || b.description || b.link);

        content.blocks = blocks;

        // Generar el HTML exacto
        const htmlContent = generateEmailHTML(content, template);

        // Usar la API de Clipboard moderna
        if (navigator.clipboard && navigator.clipboard.write) {
          const type = "text/html";
          const blob = new Blob([htmlContent], { type });
          const data = [new ClipboardItem({ [type]: blob })];

          await navigator.clipboard.write(data);
          showNotification("‚úÖ Email copiado con formato exacto");
        } else {
          // Fallback legacy
          const textArea = document.createElement("textarea");
          textArea.value = htmlContent;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          showNotification("‚ö†Ô∏è Copiado como c√≥digo HTML (Navegador antiguo)");
        }
      } catch (err) {
        console.error("Error al copiar:", err);
        showNotification("‚ùå Error al copiar");
      }
    }

    function showNotification(message: string) {
      const notification = document.createElement("div");
      notification.textContent = message;
      notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease-out;
    `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    function clearForm() {
      if (
        confirm("¬øBorrar todo el contenido? Esta acci√≥n no se puede deshacer.")
      ) {
        const form = document.getElementById(
          "newsletter-form",
        ) as HTMLFormElement;
        form?.reset();
        document.getElementById("blocks-container")!.innerHTML = "";
        addBlock(); // Agregar uno vac√≠o
        updatePreview();
      }
    }

    // Exponer funciones al window
    (window as any).copyToClipboard = copyToClipboard;
    (window as any).addBlock = addBlock;
    (window as any).removeBlock = removeBlock;
    (window as any).moveBlock = moveBlock;
    (window as any).toggleBlock = toggleBlock;
    (window as any).clearForm = clearForm;
    (window as any).updatePreview = updatePreview;

    // Inicializaci√≥n
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("newsletter-form");
      if (form) {
        form.addEventListener("input", updatePreview);
        form.addEventListener("change", updatePreview);
      }

      // Agregar bloque inicial si est√° vac√≠o
      if (document.getElementById("blocks-container")?.children.length === 0) {
        addBlock();
      }

      updatePreview();
    });
  </script>
</div>

<style>
  .newsletter-app {
    display: block;
  }

  .editor-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: var(--spacing-lg);
  }

  @media (max-width: 1024px) {
    .editor-grid {
      grid-template-columns: 1fr;
    }
  }

  .editor-panel {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: none;
    padding: var(--spacing-lg);
  }

  .form-section {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: none;
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
  }

  #blocks-container {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    min-height: 120px;
    background: transparent;
  }

  .empty-state {
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.95rem;
    padding: var(--spacing-md);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin: 0;
    font-size: 1.1rem;
    color: var(--color-text-main);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
  }
  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    margin-bottom: var(--spacing-md);
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--color-text-main);
  }
  input,
  textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 14px;
    transition:
      box-shadow 0.2s,
      border-color 0.2s,
      transform 0.15s;
    background: var(--color-surface);
  }
  input:focus,
  textarea:focus {
    border-color: var(--color-border);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    outline: none;
  }
  input:invalid {
    border-color: var(--color-danger);
  }
  input:valid:not(:placeholder-shown) {
    border-color: var(--color-success);
  }

  .required {
    color: var(--color-danger);
  }

  .actions-footer {
    display: flex;
    gap: var(--spacing-sm);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 14px;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    cursor: pointer;
    transition:
      transform 0.1s,
      box-shadow 0.2s,
      background 0.2s;
  }
  .btn-sm {
    padding: 8px 12px;
    font-size: 0.9rem;
  }
  .btn-primary {
    background: var(--color-primary);
    color: #fff;
  }
  .btn-success {
    background: var(--color-success);
    color: #fff;
  }
  .btn-secondary {
    background: var(--color-secondary);
    color: #fff;
  }
  .btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .btn-icon {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    cursor: pointer;
  }
  .btn-icon:hover {
    background: var(--color-surface-alt);
  }
  .btn-icon.delete {
    border-color: var(--color-danger);
    color: var(--color-danger);
  }

  .block-item {
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: none;
    overflow: hidden;
    margin-bottom: var(--spacing-md);
    transition:
      border-color 0.2s,
      transform 0.2s,
      opacity 0.2s;
  }
  .block-item:hover {
    border-color: #d6d6d6;
  }
  .block-item.new {
    opacity: 0.6;
    transform: translateY(4px);
  }
  .block-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: transparent;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
  }
  .block-title-display {
    font-weight: 600;
    color: var(--color-text-main);
  }
  .block-content {
    padding: var(--spacing-md);
    transition: max-height 0.2s ease;
  }
  .block-content.collapsed {
    display: none;
  }
  .block-controls {
    display: flex;
    gap: 8px;
  }

  /* Preview panel simulating an email client */
  .preview-panel {
    position: relative;
  }
  .preview-sticky {
    position: sticky;
    top: var(--spacing-md);
  }
  .email-client-simulator {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }
  .client-header {
    background: var(--color-surface-alt);
    border-bottom: 1px solid var(--color-border);
    padding: var(--spacing-md);
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: var(--spacing-md);
  }
  .window-controls {
    display: flex;
    gap: 8px;
  }
  .control {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  .control.close {
    background: #ff5f56;
  }
  .control.minimize {
    background: #ffbd2e;
  }
  .control.maximize {
    background: #27c93f;
  }
  .client-toolbar {
    display: flex;
    gap: var(--spacing-lg);
    align-items: center;
    color: var(--color-text-muted);
  }
  .client-info .label {
    font-weight: 600;
    color: var(--color-text-main);
    margin-right: 6px;
  }
  .client-actions {
    display: flex;
    align-items: center;
  }
  .btn-copy {
    box-shadow: var(--shadow-sm);
  }
  .client-body {
    background: var(--color-bg);
    padding: var(--spacing-lg);
  }
  .email-preview {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
  }

  /* Micro-interactions */
  .block-header:hover {
    background: #f5f7f9;
  }
  .block-item:focus-within {
    box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.08);
  }
  .btn-primary:active,
  .btn-success:active,
  .btn-secondary:active {
    transform: translateY(0);
    box-shadow: var(--shadow-sm);
  }

  .input-group {
    display: flex;
    align-items: center;
    border: 2px solid var(--color-border);
    border-radius: var(--radius-sm);
    background: var(--color-surface);
  }
  .input-prefix {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 10px;
    color: var(--color-secondary);
  }
  .input-group input {
    border: none;
    outline: none;
    padding: 12px;
    flex: 1;
    background: white;
  }
  .input-group:focus-within {
    border-color: var(--color-border);
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
  }
  .help-text {
    color: var(--color-text-muted);
    font-size: 12px;
    margin-top: 6px;
  }
  /* Minimal style for specific block */
  #block-1763941420823 {
    background: transparent;
  }
  #block-1763941420823 .block-header {
    background: transparent;
  }
  #block-1763941420823 .block-content {
    padding: var(--spacing-md);
  }
</style>
